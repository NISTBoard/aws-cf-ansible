#jinja2:lstrip_blocks:False,trim_blocks:False
---
AWSTemplateFormatVersion: "2010-09-09"

Description: Base Network Infrastructure

Resources:
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: {{ vpc.cidr }}
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: {{ stack_prefix | lower }}_vpc

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: {{ stack_prefix | lower }}_ig

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: { Ref: Vpc }
      InternetGatewayId: { Ref: InternetGateway }

# Route Tables #
  InternalRouteTbl:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: { Ref: Vpc }
      Tags:
        - Key: Name
          Value: {{ stack_prefix | lower }}_internal_rt

  ExternalRouteTbl:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: { Ref: Vpc }
      Tags:
        - Key: Name
          Value: {{ stack_prefix | lower }}_external_rt

# Subnets and Associations #
{% for segment_name,segment in segments.iteritems() %}
  {% set segment_loop = loop %}
  {% for subnet in range(1, segment.azs + 1) %}
  # Subnets #
  {{ segment_name }}Subnet{{ subnet }}:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: {{ lookup('get_azs').split(',')[subnet - 1] }}
      CidrBlock: {{ vpc.cidr | ipsubnet(vpc.slash, segment_loop.index0) | ipsubnet(segment.slash, subnet - 1) }}
      VpcId: { Ref: Vpc }
      Tags:
        - Key: Name
          Value: {{ stack_prefix | lower }}_{{ segment_name | lower }}

  # Associate Subnet with RouteTable #
  {% if segment_name == 'Public' %}
    {% set route_table_name = 'ExternalRouteTbl' %}
  {% else %}
    {% set route_table_name = 'InternalRouteTbl' %}
  {% endif %}

  {{ segment_name }}RouteTblAss{{ subnet }}:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: { Ref: {{ route_table_name }} }
      SubnetId: { Ref: {{ segment_name }}Subnet{{ subnet }} }

  {% endfor %}
{% endfor %}
